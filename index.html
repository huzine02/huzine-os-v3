<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUZINE OS // HYBRID BUILDER</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- PALETTE REFINED (Linear/Sunsama) --- */
            --bg-deep: #030406;
            --bg-surface: #0A0C10;
            --bg-glass: rgba(18, 18, 23, 0.65);
            --bg-glass-hover: rgba(25, 25, 30, 0.8);
            
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.12);
            --border-highlight: rgba(255, 255, 255, 0.2);

            /* Accents Refined */
            --pro-blue: #2563EB;
            --pro-blue-dim: rgba(37, 99, 235, 0.15);
            --saas-green: #0D9F6E;
            --saas-green-dim: rgba(13, 159, 110, 0.15);
            --patri-purple: #7C3AED;
            --patri-purple-dim: rgba(124, 58, 237, 0.15);
            --vie-pink: #DB2777;
            --vie-pink-dim: rgba(219, 39, 119, 0.15);
            --office-orange: #F97316; /* NEW: Pour le mode Bureau */
            
            --star-gold: #F59E0B;
            --star-gold-glow: rgba(245, 158, 11, 0.2);
            --alert-red: #DC2626;
            --alert-glow: rgba(220, 38, 38, 0.3);

            --text-main: #F8FAFC;
            --text-muted: #94A3B8;
            --text-dim: #475569;

            /* Spacing & Radius */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            
            --ease-spring: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- GLOBAL RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(37, 99, 235, 0.06), transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(13, 159, 110, 0.04), transparent 30%);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            font-size: 14px;
            line-height: 1.5;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* --- ANIMATIONS --- */
        @keyframes slideInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulseSoft { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } 50% { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        @keyframes pulseOffice { 0% { opacity: 0.8; } 50% { opacity: 1; box-shadow: 0 0 15px rgba(249, 115, 22, 0.1); } 100% { opacity: 0.8; } }

        /* --- HEADER --- */
        header#main-header {
            background: rgba(3, 4, 6, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 50;
        }

        .brand { 
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 700; 
            color: var(--text-main); 
            font-size: 1rem; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            letter-spacing: -0.02em;
        }
        .brand span { color: var(--text-dim); font-weight: 400; }
        
        /* NEW: OFFICE MODE TAG */
        .office-tag { 
            display: none; /* Hidden by default */
            background: rgba(249, 115, 22, 0.15); 
            color: var(--office-orange);
            border: 1px solid rgba(249, 115, 22, 0.3);
            font-size: 0.65rem; padding: 4px 10px; border-radius: 6px; font-weight: 700;
            align-items: center; gap: 6px;
            animation: pulseOffice 3s infinite;
        }
        .office-tag.active { display: flex; }

        .crisis-tag { 
            background: rgba(220, 38, 38, 0.15); 
            color: var(--alert-red); 
            font-size: 0.65rem; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-weight: 700; 
            letter-spacing: 0.05em;
            border: 1px solid rgba(220, 38, 38, 0.2);
            animation: pulseSoft 2s infinite; 
        }

        /* INPUTS & CONTROLS */
        .braindump-wrapper { 
            flex: 1; 
            max-width: 480px; 
            margin: 0 32px; 
            position: relative; 
        }
        .braindump-input {
            width: 100%; 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--border-subtle);
            color: var(--text-main); 
            padding: 10px 16px 10px 42px; 
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif; 
            font-size: 0.85rem; 
            transition: all 0.2s var(--ease-smooth);
        }
        .braindump-input:focus { 
            background: rgba(255, 255, 255, 0.05); 
            border-color: var(--text-muted); 
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        }
        .braindump-icon { 
            position: absolute; 
            left: 14px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-dim); 
            font-size: 0.9rem;
        }

        .header-controls { display: flex; gap: 12px; align-items: center; }
        
        .btn-header, .btn-icon {
            background: transparent; 
            color: var(--text-muted); 
            border: 1px solid var(--border-subtle);
            height: 34px; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            display: flex;
            align-items: center; 
            justify-content: center; 
            font-family: 'Inter', sans-serif;
            font-weight: 500; 
            font-size: 0.8rem; 
            transition: all 0.2s var(--ease-smooth);
        }
        .btn-header { padding: 0 16px; gap: 8px; }
        .btn-icon { width: 34px; }
        
        .btn-header:hover, .btn-icon:hover { 
            background: rgba(255,255,255,0.04); 
            color: var(--text-main); 
            border-color: var(--text-muted); 
            transform: translateY(-1px);
        }
        
        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar { 
            width: 72px; 
            background: rgba(10, 12, 16, 0.6); 
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border-subtle); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: 24px; 
            gap: 12px; 
            z-index: 40;
        }
        .nav-item { 
            width: 48px; height: 48px; 
            border-radius: 12px; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            cursor: pointer; 
            color: var(--text-dim); 
            transition: all 0.3s var(--ease-spring); 
            font-size: 0.6rem; 
            gap: 4px; 
            font-weight: 500; 
            position: relative;
        }
        .nav-item i { font-style: normal; font-size: 1.25rem; margin-bottom: 2px; filter: grayscale(1); transition: filter 0.3s; }
        .nav-item:hover { color: var(--text-main); background: rgba(255,255,255,0.03); transform: scale(1.05); }
        .nav-item:hover i { filter: grayscale(0); }
        .nav-item.active { 
            color: var(--text-main); 
            background: rgba(255,255,255,0.06); 
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
        }
        .nav-item.active i { filter: grayscale(0); }
        .nav-item.active::before {
            content: ''; position: absolute; left: -13px; top: 14px; bottom: 14px; width: 3px;
            background: var(--text-main); border-radius: 0 4px 4px 0;
            box-shadow: 2px 0 8px rgba(255,255,255,0.2);
        }

        /* MAIN CONTENT */
        .main-content { 
            flex: 1; 
            padding: 32px 48px; 
            overflow-y: auto; 
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .view-section { 
            display: none; 
            animation: slideInUp 0.5s var(--ease-spring); 
        }
        .view-section.active { display: block; }

        /* DASHBOARD HEADERS */
        .cockpit-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            margin-bottom: 32px; 
        }
        .day-badge { 
            padding: 6px 16px; 
            border-radius: 100px; 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.05em;
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            color: white; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2); 
        }
        .greeting { 
            color: var(--text-muted); 
            font-size: 1rem; 
            font-weight: 400; 
            margin-top: 8px; 
            letter-spacing: -0.01em;
        }
        .greeting span { color: var(--text-main); font-weight: 600; }

        /* --- TOP 3 CARD --- */
        .top3-card {
            background: linear-gradient(180deg, rgba(20, 23, 28, 0.6), rgba(10, 12, 16, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.15); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin-bottom: 32px; 
            position: relative; 
            overflow: hidden;
            box-shadow: 
                0 0 0 1px rgba(245, 158, 11, 0.05),
                0 20px 40px -10px rgba(0,0,0,0.4),
                0 0 60px rgba(245, 158, 11, 0.03);
        }
        .top3-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--star-gold), transparent); 
            opacity: 0.4;
        }
        .top3-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .top3-title { 
            font-weight: 600; 
            font-size: 0.85rem; 
            color: var(--star-gold); 
            letter-spacing: 0.05em; 
            display: flex; align-items: center; gap: 8px; 
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        .top3-count { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.75rem; 
            color: var(--text-muted); 
            background: rgba(255,255,255,0.05); 
            padding: 4px 8px; 
            border-radius: 6px; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .top3-list { display: flex; flex-direction: column; gap: 12px; }
        .top3-empty { 
            color: var(--text-dim); 
            font-size: 0.9rem; 
            font-style: italic; 
            opacity: 0.6; 
            padding: 20px; 
            text-align: center; 
            border: 1px dashed var(--border-subtle);
            border-radius: var(--radius-sm);
        }

        /* --- PILLAR GRID (GLASSMORPHISM) --- */
        .pillar-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 32px; 
        }
        .pillar-card {
            background: var(--bg-glass); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md); 
            padding: 20px; 
            display: flex; 
            flex-direction: column;
            transition: all 0.3s var(--ease-spring); 
            min-height: 260px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
        }
        .pillar-card:hover { 
            transform: translateY(-4px) scale(1.01); 
            box-shadow: 0 12px 30px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.05);
            background: var(--bg-glass-hover);
            border-color: var(--border-hover);
        }

        /* NEW: BUDGET BAR STYLES */
        .budget-container { margin-bottom: 12px; margin-top: -8px; }
        .budget-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-dim); margin-bottom: 4px; font-family: 'JetBrains Mono', monospace; }
        .budget-track { width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
        .budget-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        .pillar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
            padding-bottom: 12px; 
            border-bottom: 1px solid var(--border-subtle); 
        }
        .pillar-title { 
            font-weight: 600; 
            font-size: 0.95rem; 
            color: var(--text-main); 
            display: flex; align-items: center; gap: 10px; 
            letter-spacing: -0.01em;
        }
        .pillar-tasks { flex: 1; display: flex; flex-direction: column; gap: 4px; }

        /* TASKS REFINED */
        .task-row { 
            display: flex; 
            align-items: center; 
            padding: 10px 12px; 
            border-radius: var(--radius-sm); 
            transition: all 0.2s; 
            border: 1px solid transparent; 
            cursor: pointer;
        }
        .task-row:hover { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.05); }
        .task-check { 
            appearance: none; 
            width: 18px; height: 18px; 
            border: 1.5px solid var(--text-dim); 
            border-radius: 5px; 
            margin-right: 14px; 
            cursor: pointer; 
            position: relative; 
            flex-shrink: 0; 
            transition: all 0.2s;
            background: transparent;
        }
        .task-check:checked { background: var(--saas-green); border-color: var(--saas-green); box-shadow: 0 0 10px var(--saas-green-dim); }
        .task-check:checked::after { content: ''; position: absolute; left: 5px; top: 1px; width: 4px; height: 9px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
        .task-content { flex: 1; font-size: 0.9rem; color: var(--text-main); transition: color 0.2s; font-weight: 400; }
        .task-done .task-content { text-decoration: line-through; color: var(--text-dim); opacity: 0.7; }
        .task-type-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; box-shadow: 0 0 8px currentColor; }
        .task-star { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--text-dim); opacity: 0.3; margin-left: 10px; transition: all 0.2s; }
        .task-row:hover .task-star { opacity: 1; }
        .task-star.active { color: var(--star-gold); opacity: 1; transform: scale(1.1); text-shadow: 0 0 10px var(--star-gold-glow); }
        .task-delete { background: none; border: none; color: var(--alert-red); cursor: pointer; opacity: 0; margin-left: 10px; transition: all 0.2s; }
        .task-row:hover .task-delete { opacity: 0.6; }
        .task-delete:hover { opacity: 1; transform: scale(1.1); }
        .add-task-btn { width: 100%; padding: 12px; margin-top: 16px; background: rgba(255,255,255,0.02); border: 1px dashed var(--border-subtle); color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); font-size: 0.8rem; transition: all 0.2s; font-weight: 500; }
        .add-task-btn:hover { background: rgba(255,255,255,0.05); border-color: var(--text-muted); color: var(--text-main); }

        /* JOURNAL & PROJECTS */
        .journal-section, .project-card { background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden; margin-top: 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .journal-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .journal-header:hover { background: rgba(255,255,255,0.02); }
        .journal-title { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .journal-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .journal-body.expanded { max-height: 400px; padding: 0 20px 20px; border-top: 1px solid var(--border-subtle); overflow-y: auto; }
        .journal-input-row { display: flex; gap: 10px; margin-bottom: 12px; margin-top: 12px; }
        .journal-input { flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-main); border-radius: var(--radius-sm); padding: 10px 14px; font-family: var(--font-ui); font-size: 0.85rem; }
        .journal-input:focus { border-color: var(--pro-blue); }
        .journal-entry { padding: 8px 0; border-bottom: 1px solid var(--border-light); font-size: 0.85rem; display: flex; gap: 12px; align-items: baseline; }
        .journal-time { color: var(--pro-blue); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; opacity: 0.8; }

        .smart-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        .smart-table th { text-align: left; padding: 14px 10px; color: var(--text-muted); border-bottom: 1px solid var(--border-subtle); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        .smart-table td { padding: 12px 10px; border-bottom: 1px solid var(--border-subtle); vertical-align: middle; }
        
        .project-card { padding: 24px; margin-bottom: 24px; }
        .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .project-title { font-weight: 600; font-size: 1.1rem; color: var(--text-main); }
        .project-input-row { display: flex; gap: 10px; margin-top: 16px; }
        .project-input { flex: 1; background: var(--bg-subtle); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 8px 12px; color: var(--text-main); font-size: 0.85rem; background: rgba(0,0,0,0.2); }

        /* TIMELINE */
        .timeline-track { background: rgba(255,255,255,0.05); height: 6px; border-radius: 10px; margin: 16px 0 24px; overflow: hidden; }
        .timeline-bar { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--pro-blue), var(--saas-green)); box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); transition: width 0.5s ease; }

        /* FOCUS OVERLAY */
        .focus-overlay { 
            background: linear-gradient(180deg, #050505 0%, #0A0C10 100%);
            position: fixed; inset: 0; z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .focus-overlay.show { display: flex; opacity: 1; animation: fadeIn 0.4s ease forwards; }
        .focus-overlay::before { content: ""; position: absolute; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E"); pointer-events: none; z-index: -1; }
        .focus-type { color: var(--pro-blue); font-size: 0.8rem; font-weight: 700; letter-spacing: 0.15em; margin-bottom: 24px; text-transform: uppercase; background: rgba(37, 99, 235, 0.1); padding: 6px 16px; border-radius: 100px; border: 1px solid rgba(37, 99, 235, 0.2); }
        .focus-task { font-size: 2.5rem; font-weight: 600; text-align: center; max-width: 800px; margin-bottom: 32px; line-height: 1.3; color: #fff; text-shadow: 0 0 30px rgba(255,255,255,0.1); letter-spacing: -0.02em; }
        .focus-timer { font-size: 3rem; color: var(--text-muted); font-weight: 400; margin-bottom: 48px; font-family: 'JetBrains Mono', monospace; opacity: 0.8; }
        .focus-btn { padding: 16px 40px; border-radius: 100px; font-size: 1rem; border:none; cursor: pointer; transition: all 0.2s var(--ease-spring); font-weight: 600; letter-spacing: 0.02em; }
        .focus-btn.primary { background: var(--text-main); color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .focus-btn.primary:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(255,255,255,0.4); }
        .focus-btn.secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); margin-right: 12px; }
        .focus-btn.secondary:hover { background: rgba(255,255,255,0.1); }
        .focus-exit { position: absolute; top: 32px; right: 32px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); padding: 8px 16px; border-radius: 100px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .focus-exit:hover { background: rgba(255,255,255,0.1); color: white; }

        /* WEEK GRID */
        .week-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-top: 1.5rem; }
        .week-day { background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 16px 8px; transition: all 0.2s; text-align: center; }
        .week-day.today { background: var(--saas-green-dim); border-color: var(--saas-green); box-shadow: 0 4px 15px rgba(13, 159, 110, 0.1); }
        .week-day-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; }
        .week-day-theme { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(12px); background: rgba(0,0,0,0.7); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s ease; }
        .modal-content { background: #0F1115; border: 1px solid var(--border-subtle); box-shadow: 0 20px 60px rgba(0,0,0,0.6); text-align: center; max-width: 420px; width: 90%; padding: 2rem; border-radius: var(--radius-lg); }
        .shutdown-title { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 0.5rem; }
        .shutdown-subtitle { color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem; }
        .shutdown-btn { background: var(--text-main); color: #000; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer; width: 100%; border-radius: var(--radius-sm); font-size: 0.9rem; transition: transform 0.2s; }
        .shutdown-btn:hover { transform: scale(1.02); }
        .import-area { width: 100%; height: 120px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); color: var(--saas-green); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 12px; border-radius: var(--radius-sm); margin-bottom: 1rem; resize: none; }
        .copy-prompt-btn { background: rgba(59, 130, 246, 0.1); color: var(--pro-blue); border: 1px solid rgba(59, 130, 246, 0.2); padding: 10px; width: 100%; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.8rem; cursor: pointer; margin-bottom: 1rem; }

        /* RESPONSIVE */
        @media (max-width: 1024px) { .pillar-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { width: 64px; } .braindump-wrapper { display: none; } .pillar-grid { grid-template-columns: 1fr; } .week-grid { grid-template-columns: repeat(3, 1fr); } .main-content { padding: 20px; }
            .top3-header { flex-direction: column; align-items: flex-start; gap: 10px; } .cockpit-header { flex-direction: column; align-items: flex-start; gap: 16px; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header id="main-header">
    <div class="brand">
        HUZINE<span>//OS</span>
        <span class="crisis-tag hidden" id="crisis-tag">CRISE</span>
        <!-- NEW OFFICE TAG -->
        <span id="office-alert" class="office-tag">üè¢ BUREAU</span>
    </div>
    <div class="braindump-wrapper">
        <span class="braindump-icon">‚ö°</span>
        <input type="text" id="braindump-input" class="braindump-input" placeholder="Capture rapide... (Entr√©e)">
    </div>
    <div class="header-controls">
        <div id="clock" style="font-family:'JetBrains Mono'; font-weight:600; margin-right:8px;">00:00</div>
        <button class="btn-header" onclick="openAiImport()" style="border-color:var(--patri-purple); color:var(--patri-purple);" title="Import IA">üì• IMPORT IA</button>
        <button class="btn-header" id="btn-focus" onclick="toggleFocusMode()">üéØ FOCUS</button>
        <button class="btn-header crisis" id="btn-crisis" onclick="toggleCrisisMode()">üö®</button>
        <button class="btn-header" onclick="exportData()">üíæ</button>
        <button class="btn-icon" onclick="document.getElementById('import-file').click()">üìÇ</button>
        <input type="file" id="import-file" style="display:none" onchange="importData(this)">
    </div>
</header>

<div class="container">
    <nav class="sidebar">
        <div class="nav-item active" onclick="switchTab('dashboard', this)"><i>üöÄ</i><span>Day</span></div>
        <div class="nav-item" onclick="switchTab('pro', this)"><i>üíº</i><span>Pro</span></div>
        <div class="nav-item" onclick="switchTab('saas', this)"><i>üíª</i><span>SaaS</span></div>
        <div class="nav-item" onclick="switchTab('vie', this)"><i>üß¨</i><span>Vie</span></div>
        <div class="nav-item" onclick="switchTab('patrimoine', this)"><i>üèóÔ∏è</i><span>Patri</span></div>
        <div class="nav-item" onclick="switchTab('review', this)"><i>üìÖ</i><span>Plan</span></div>
    </nav>

    <main class="main-content">
        <!-- DASHBOARD -->
        <section id="view-dashboard" class="view-section active">
            <div class="cockpit-header">
                <div class="day-info">
                    <div id="day-badge" class="day-badge">CHARGEMENT...</div>
                    <div class="greeting"><span id="greeting-text">Bonjour</span>, Huzine.</div>
                </div>
                <button onclick="openShutdown()" class="btn-header" style="color:var(--star-gold); border-color:var(--star-gold);">üåô Shutdown</button>
            </div>

            <!-- TOP 3 -->
            <div class="top3-card">
                <div class="top3-header">
                    <span class="top3-title">‚≠ê TOP 3 DU JOUR</span>
                    <span class="top3-count" id="top3-count">0/3</span>
                </div>
                <div class="top3-list" id="top3-list"></div>
            </div>

            <!-- 4 PILLAR CARDS WITH BUDGET BARS -->
            <div class="pillar-grid" id="pillar-grid"></div>

            <!-- JOURNAL -->
            <div class="journal-section">
                <div class="journal-header" onclick="toggleJournal()">
                    <span class="journal-title">üìù Journal de transition</span>
                    <span class="journal-toggle" id="journal-toggle">‚ñº Afficher</span>
                </div>
                <div class="journal-body" id="journal-body">
                    <div class="journal-input-row">
                        <input type="text" id="journal-input" class="journal-input" placeholder="Comment je me sens ?">
                        <button onclick="addJournalEntry()" class="btn-icon" style="width:36px;">+</button>
                    </div>
                    <div class="journal-entries" id="journal-entries"></div>
                </div>
            </div>
        </section>

        <!-- PRO -->
        <section id="view-pro" class="view-section">
            <h2 style="color:var(--pro-blue); margin-bottom:1rem; font-size:1.2rem; font-weight:700;">üíº PRO / Dell</h2>
            <div class="project-card">
                <table class="smart-table">
                    <thead><tr><th width="30"></th><th>T√¢che</th><th width="50">‚≠ê</th><th width="40"></th></tr></thead>
                    <tbody id="table-pro-body"></tbody>
                </table>
                <button onclick="addNewTask('pro')" class="add-task-btn">+ Ajouter t√¢che PRO</button>
            </div>
        </section>

        <!-- SAAS -->
        <section id="view-saas" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 style="color:var(--saas-green); font-size:1.2rem; font-weight:700;">üíª SaaS / Nutri-Track</h2>
                <div style="display:flex; gap:6px;">
                    <input type="text" id="input-mrr" placeholder="MRR ‚Ç¨" style="background:var(--bg-subtle); border:1px solid var(--border-subtle); padding:5px 8px; color:white; width:80px; border-radius:4px; font-size:0.8rem;" onchange="updateMetrics()">
                    <input type="text" id="input-users" placeholder="Users" style="background:var(--bg-subtle); border:1px solid var(--border-subtle); padding:5px 8px; color:white; width:70px; border-radius:4px; font-size:0.8rem;" onchange="updateMetrics()">
                </div>
            </div>
            <div class="project-card">
                <table class="smart-table">
                    <thead><tr><th width="30"></th><th>Feature / T√¢che</th><th width="50">‚≠ê</th><th width="40"></th></tr></thead>
                    <tbody id="table-saas-body"></tbody>
                </table>
                <button onclick="addNewTask('saas')" class="add-task-btn">+ Ajouter t√¢che SaaS</button>
            </div>
        </section>

        <!-- VIE -->
        <section id="view-vie" class="view-section">
            <h2 style="color:var(--vie-pink); margin-bottom:1rem; font-size:1.2rem; font-weight:700;">üß¨ Vie / Admin</h2>
            <div class="project-card">
                <table class="smart-table">
                    <thead><tr><th width="30"></th><th>T√¢che</th><th width="50">‚≠ê</th><th width="40"></th></tr></thead>
                    <tbody id="table-vie-body"></tbody>
                </table>
                <button onclick="addNewTask('vie')" class="add-task-btn">+ Ajouter (docteur, admin...)</button>
            </div>
        </section>

        <!-- PATRIMOINE -->
        <section id="view-patrimoine" class="view-section">
            <h2 style="color:var(--patri-purple); margin-bottom:1rem; font-size:1.2rem; font-weight:700;">üèóÔ∏è Patrimoine</h2>
            
            <div class="project-card" style="border-left: 3px solid var(--patri-purple);">
                <div class="project-header">
                    <div class="project-title">üá©üáø Annaba</div>
                    <span style="font-size:0.75rem; color:var(--text-muted);">Fin: <input type="date" id="date-annaba" style="background:none; border:none; color:var(--text-main); font-size:0.75rem;" onchange="saveData()"></span>
                </div>
                <div class="timeline-track"><div class="timeline-bar" id="bar-annaba"></div></div>
                <div id="list-annaba"></div>
                <div class="project-input-row">
                    <input type="text" id="input-annaba" class="project-input" placeholder="Nouveau jalon...">
                    <button onclick="addProjectTask('annaba')" class="btn-icon">+</button>
                </div>
            </div>

            <div class="project-card" style="border-left: 3px solid var(--star-gold);">
                <div class="project-header">
                    <div class="project-title">üè¢ Copropri√©t√©</div>
                    <span style="font-size:0.75rem; color:var(--text-muted);">Fin: <input type="date" id="date-copro" style="background:none; border:none; color:var(--text-main); font-size:0.75rem;" onchange="saveData()"></span>
                </div>
                <div class="timeline-track"><div class="timeline-bar" id="bar-copro" style="background: linear-gradient(90deg, var(--star-gold), var(--patri-purple));"></div></div>
                <div id="list-copro"></div>
                <div class="project-input-row">
                    <input type="text" id="input-copro" class="project-input" placeholder="Nouveau jalon...">
                    <button onclick="addProjectTask('copro')" class="btn-icon">+</button>
                </div>
            </div>

            <div class="project-card">
                <div class="project-header"><div class="project-title">üè† Airbnb</div><span style="font-size:0.7rem; color:var(--text-muted);">Hebdo</span></div>
                <div id="list-airbnb"></div>
                <div class="project-input-row">
                    <input type="text" id="input-airbnb" class="project-input" placeholder="T√¢che r√©currente...">
                    <button onclick="addProjectTask('airbnb')" class="btn-icon">+</button>
                </div>
            </div>
            <div class="project-card">
                <div class="project-header"><div class="project-title">üè° Maison</div><span style="font-size:0.7rem; color:var(--text-muted);">Mensuel</span></div>
                <div id="list-maison"></div>
                <div class="project-input-row">
                    <input type="text" id="input-maison" class="project-input" placeholder="T√¢che r√©currente...">
                    <button onclick="addProjectTask('maison')" class="btn-icon">+</button>
                </div>
            </div>
        </section>

        <!-- REVIEW -->
        <section id="view-review" class="view-section">
            <h2 style="margin-bottom:1rem; font-size:1.2rem; font-weight:700;">üìÖ Architecture Semaine</h2>
            <div class="week-grid" id="week-grid"></div>
            <div class="project-card" style="margin-top:24px;">
                <div class="pillar-header"><span class="pillar-title">üìù Weekly Review</span></div>
                <div style="display:flex; flex-direction:column; gap:16px;">
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:6px;">1. Victoire de la semaine ?</label>
                        <input type="text" id="review-win" class="project-input" style="width:100%;" onchange="saveReview()">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:6px;">2. Ce qui n'a pas fonctionn√© ?</label>
                        <input type="text" id="review-fail" class="project-input" style="width:100%;" onchange="saveReview()">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:6px;">3. PRIORIT√â semaine prochaine ?</label>
                        <input type="text" id="review-priority" class="project-input" style="width:100%;" onchange="saveReview()">
                        <button onclick="createTaskFromPriority()" class="shutdown-btn" style="margin-top:16px; background:var(--saas-green); color:#000;">‚Üí Cr√©er comme TOP 3</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- FOCUS -->
<div class="focus-overlay" id="focus-overlay">
    <button class="focus-exit" onclick="exitFocusMode()">‚úï Quitter</button>
    <div class="focus-type" id="focus-type-label">PRO</div>
    <div class="focus-task" id="focus-task-text">S√©lectionne une t√¢che</div>
    <div class="focus-timer" id="focus-timer-display">00:00</div>
    <div class="focus-controls" style="display:flex; gap:16px; align-items:center;">
        <button class="focus-btn secondary" id="focus-toggle-btn" onclick="toggleFocusTimer()">‚ñ∂ Timer</button>
        <button class="focus-btn primary" onclick="completeFocusTask()">‚úì TERMIN√â</button>
        <button class="focus-btn secondary" onclick="nextFocusTask()" style="margin:0;">‚Üí</button>
    </div>
</div>

<!-- SHUTDOWN -->
<div class="modal-overlay" id="shutdown-modal">
    <div class="modal-content">
        <div class="shutdown-title">üåô SHUTDOWN</div>
        <div class="shutdown-subtitle">22h45 ‚Äî Pr√©paration sommeil</div>
        <div style="text-align:left; margin-bottom:1.5rem; display:flex; flex-direction:column; gap:12px;">
            <div style="display:flex; gap:10px; align-items:center;"><input type="checkbox" class="task-check" style="margin:0;"><label style="color:var(--text-muted); font-size:0.9rem;">Victoire not√©e</label></div>
            <div style="display:flex; gap:10px; align-items:center;"><input type="checkbox" class="task-check" style="margin:0;"><label style="color:var(--text-muted); font-size:0.9rem;">Top 3 demain:</label></div>
            <input type="text" id="shutdown-tomorrow" class="project-input" placeholder="1. / 2. / 3.">
            <div style="display:flex; gap:10px; align-items:center;"><input type="checkbox" class="task-check" style="margin:0;"><label style="color:var(--text-muted); font-size:0.9rem;">√âcrans √©teints</label></div>
        </div>
        <button onclick="closeShutdown()" class="shutdown-btn">BONNE NUIT üí™</button>
    </div>
</div>

<!-- AI IMPORT MODAL -->
<div class="modal-overlay" id="ai-import-modal">
    <div class="modal-content">
        <div class="shutdown-title" style="color:var(--patri-purple);">üì• IMPORT IA</div>
        <div class="shutdown-subtitle">Transforme tes PDF en t√¢ches instantan√©ment</div>
        
        <button onclick="copyAgentPrompt()" class="copy-prompt-btn">üìã 1. COPIER LE PROMPT AGENT</button>
        <textarea id="ai-import-text" class="import-area" placeholder='2. Colle le bloc JSON ici (ex: [{"type":"annaba", ...}])'></textarea>
        
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('ai-import-modal').classList.remove('show')" class="shutdown-btn" style="background:var(--bg-subtle); color:var(--text-muted);">ANNULER</button>
            <button onclick="processAiImport()" class="shutdown-btn" style="background:var(--patri-purple); color:white;">IMPORTER</button>
        </div>
    </div>
</div>

<script>
// ===============================================
// AGENT PROMPT STRING
// ===============================================
const AGENT_PROMPT = `
# R√îLE :
Tu es mon "Project Slicer" expert (M√©thodologie GTD + Agile). Je suis Huzine, Tech Manager (Dell).

# MISSION :
Analyse le document ou texte fourni.
1. D√âCOUPE ce projet en actions concr√®tes (45-60 min max).
2. CLASSE-les dans les bonnes cat√©gories.
3. G√âN√àRE UNIQUEMENT UN BLOC JSON strict.

# CAT√âGORIES ("type") :
- "pro" (Dell)
- "saas" (Nutri-Track)
- "vie" (Admin/Famille)
- "annaba" (R√©nov Alg√©rie)
- "copro" (Syndic)
- "airbnb"
- "maison"

# FORMAT DE SORTIE (JSON LIST) :
[
  {"type": "annaba", "text": "Appeler archi pour plan", "priority": "H"},
  {"type": "pro", "text": "Revue trimestrielle", "priority": "M"}
]
`;

// ===============================================
// DAY CONFIG (HYBRID BUILDER MATRIX)
// ===============================================
const dayConfig = {
    1: { name: 'Lundi', label: 'üöÄ LAUNCH & CODE', theme: 'var(--saas-green)', office: false, budgets: { pro: 2, saas: 4, patri: 1, vie: 1 } },
    2: { name: 'Mardi', label: 'üé≠ THEATRE & CODE', theme: 'var(--pro-blue)', office: true, budgets: { pro: 4, saas: 3, patri: 0, vie: 0 } },
    3: { name: 'Mercredi', label: 'üìû PIVOT ADMIN', theme: 'var(--vie-pink)', office: false, budgets: { pro: 1, saas: 2, patri: 2, vie: 3 } },
    4: { name: 'Jeudi', label: 'üè¢ THEATRE & SAAS', theme: 'var(--saas-green)', office: true, budgets: { pro: 4, saas: 4, patri: 0, vie: 0 } },
    5: { name: 'Vendredi', label: 'üìä DELIVERY', theme: 'var(--pro-blue)', office: false, budgets: { pro: 3, saas: 0, patri: 2, vie: 1 } },
    6: { name: 'Samedi', label: 'üßò‚Äç‚ôÇÔ∏è WEEK-END', theme: 'var(--vie-pink)', office: false, budgets: { pro: 0, saas: 2, patri: 0, vie: 4 } },
    0: { name: 'Dimanche', label: 'üßò‚Äç‚ôÇÔ∏è WEEK-END', theme: 'var(--vie-pink)', office: false, budgets: { pro: 0, saas: 2, patri: 0, vie: 4 } }
};

const pillarInfo = {
    pro: { icon: 'üíº', name: 'PRO', color: 'var(--pro-blue)', themeClass: 'pro', types: ['pro'] },
    saas: { icon: 'üíª', name: 'SaaS', color: 'var(--saas-green)', themeClass: 'saas', types: ['saas'] },
    vie: { icon: 'üß¨', name: 'Vie', color: 'var(--vie-pink)', themeClass: 'vie', types: ['vie'] },
    patri: { icon: 'üèóÔ∏è', name: 'Patrimoine', color: 'var(--patri-purple)', themeClass: 'patri', types: ['annaba', 'copro', 'airbnb', 'maison'] }
};

// ===============================================
// DATA & STATE
// ===============================================
const defaultData = {
    tasks: [],
    metrics: { mrr: '0', users: '0' },
    settings: { annabaDate: '', coproDate: '', crisisMode: false },
    journal: [],
    review: { win: '', fail: '', priority: '' },
    // NEW: Daily progress tracking
    dailyProgress: { pro: 0, saas: 0, patri: 0, vie: 0, lastReset: new Date().toDateString() }
};

let data = JSON.parse(localStorage.getItem('huzine_os_hybrid')) || JSON.parse(JSON.stringify(defaultData));

// Clean up old data structure if needed
if (!data.dailyProgress) { 
    data.dailyProgress = { pro: 0, saas: 0, patri: 0, vie: 0, lastReset: new Date().toDateString() };
}
data.tasks.forEach(t => { if (t.todayStar === undefined) t.todayStar = false; });

// ===============================================
// INIT
// ===============================================
function init() {
    checkDailyReset();
    updateClock();
    setInterval(updateClock, 1000);
    setInterval(checkShutdownTime, 60000);
    
    setupDay();
    renderAll();
    renderWeekGrid();
    loadReview();
    cleanJournalIfNewDay();
    updateCrisisUI();
    
    document.getElementById('braindump-input').addEventListener('keypress', e => {
        if (e.key === 'Enter' && e.target.value.trim()) {
            addTask('vie', e.target.value.trim());
            e.target.value = '';
        }
    });
    
    document.getElementById('journal-input').addEventListener('keypress', e => {
        if (e.key === 'Enter' && e.target.value.trim()) addJournalEntry();
    });
}

function checkDailyReset() {
    const today = new Date().toDateString();
    if (data.dailyProgress.lastReset !== today) {
        data.dailyProgress = { pro: 0, saas: 0, patri: 0, vie: 0, lastReset: today };
        saveData();
    }
}

function saveData() {
    const dateAnnaba = document.getElementById('date-annaba');
    const dateCopro = document.getElementById('date-copro');
    if (dateAnnaba) data.settings.annabaDate = dateAnnaba.value;
    if (dateCopro) data.settings.coproDate = dateCopro.value;
    localStorage.setItem('huzine_os_hybrid', JSON.stringify(data));
    renderAll();
}

function setupDay() {
    const today = new Date();
    const dayIdx = today.getDay();
    const hour = today.getHours();
    const config = dayConfig[dayIdx];

    // Badge
    const badge = document.getElementById('day-badge');
    badge.textContent = config.name + ' // ' + config.label;
    badge.style.background = config.theme;

    // Greeting
    const greetingText = document.getElementById('greeting-text');
    if (hour < 12) greetingText.textContent = 'Bon matin';
    else if (hour < 18) greetingText.textContent = 'Bon apr√®s-midi';
    else greetingText.textContent = 'Bonne soir√©e';

    // Office Tag Logic (Tue/Thu morning)
    const officeTag = document.getElementById('office-alert');
    if (config.office && hour < 13) {
        officeTag.classList.add('active');
    } else {
        officeTag.classList.remove('active');
    }
}

// ===============================================
// RENDERING (WITH BUDGETS)
// ===============================================
function renderPillarGrid() {
    const dayIdx = new Date().getDay();
    const config = dayConfig[dayIdx];
    const grid = document.getElementById('pillar-grid');
    
    // Fixed order based on Volumetric Matrix: Pro, SaaS, Patri, Vie
    const order = ['pro', 'saas', 'patri', 'vie'];
    
    grid.innerHTML = order.map(pillarKey => {
        const info = pillarInfo[pillarKey];
        const tasks = data.tasks.filter(t => info.types.includes(t.type));
        const activeTasks = tasks.filter(t => !t.done).slice(0, 5);
        const doneCount = tasks.filter(t => t.done).length;
        const totalCount = tasks.length;
        
        // Budget Calc
        const budget = config.budgets[pillarKey];
        const current = data.dailyProgress[pillarKey] || 0;
        const pct = budget > 0 ? Math.min((current / budget) * 100, 100) : 0;
        
        // Determines opacity based on importance today
        let cardClass = 'medium';
        if (budget >= 3) cardClass = 'focus';
        else if (budget === 0) cardClass = 'faded';

        let budgetHtml = '';
        if (budget === 0) {
            budgetHtml = `<div class="budget-labels"><span>OFF TODAY</span><span>--</span></div><div class="budget-track"><div class="budget-fill" style="width:0; background:${info.color}"></div></div>`;
        } else {
            budgetHtml = `
                <div class="budget-labels">
                    <span>Objectif: ${budget}h</span>
                    <span>${current.toFixed(1)}h</span>
                </div>
                <div class="budget-track">
                    <div class="budget-fill" style="width:${pct}%; background:${info.color}"></div>
                </div>`;
        }
        
        return `
            <div class="pillar-card ${cardClass} ${info.themeClass}" style="--theme: ${info.color}">
                ${cardClass === 'focus' ? '<div class="pillar-focus-tag">FOCUS</div>' : ''}
                <div class="pillar-header">
                    <span class="pillar-title" style="color:${info.color}">${info.icon} ${info.name}</span>
                    <span class="pillar-badge">${totalCount - doneCount}</span>
                </div>
                <div class="budget-container">${budgetHtml}</div>
                <div class="pillar-tasks">
                    ${activeTasks.length === 0 ? '<div class="top3-empty" style="border:none; padding:10px 0; font-size:0.8rem; text-align:left;">Aucune t√¢che active.</div>' : 
                        activeTasks.map(t => `
                            <div class="task-row">
                                <input type="checkbox" class="task-check" onclick="event.stopPropagation(); toggleTask(${t.id}, '${pillarKey}')">
                                <span class="task-content" onclick="startFocusOnTask(${t.id})">${escapeHtml(t.text)}</span>
                                <button class="task-star ${t.todayStar ? 'active' : ''}" onclick="event.stopPropagation(); toggleStar(${t.id})">‚òÖ</button>
                            </div>
                        `).join('')
                    }
                </div>
                <button class="add-task-btn" onclick="addNewTask('${info.types[0]}')">+ Ajouter</button>
            </div>
        `;
    }).join('');
}

function renderTop3() {
    const el = document.getElementById('top3-list');
    const countEl = document.getElementById('top3-count');
    const starred = data.tasks.filter(t => t.todayStar && !t.done);
    countEl.textContent = starred.length + '/3';
    
    if (starred.length === 0) {
        el.innerHTML = '<div class="top3-empty">Clique sur ‚òÖ pour marquer tes priorit√©s du jour</div>';
        return;
    }
    
    const getColor = (type) => {
        if (type === 'pro') return 'var(--pro-blue)';
        if (type === 'saas') return 'var(--saas-green)';
        if (type === 'vie') return 'var(--vie-pink)';
        return 'var(--patri-purple)';
    };
    
    el.innerHTML = starred.map(t => `
        <div class="task-row">
            <input type="checkbox" class="task-check" onclick="event.stopPropagation(); toggleTask(${t.id}, '${getPillarKey(t.type)}')">
            <span class="task-type-dot" style="background:${getColor(t.type)}; color:${getColor(t.type)}"></span>
            <span class="task-content" onclick="startFocusOnTask(${t.id})">${escapeHtml(t.text)}</span>
            <button class="task-star active" onclick="event.stopPropagation(); toggleStar(${t.id})">‚òÖ</button>
        </div>
    `).join('');
}

function getPillarKey(type) {
    if(['annaba','copro','airbnb','maison'].includes(type)) return 'patri';
    return type; // pro, saas, vie
}

function renderTable(elementId, type) {
    const el = document.getElementById(elementId);
    if (!el) return;
    const tasks = data.tasks.filter(t => t.type === type);
    tasks.sort((a, b) => a.done - b.done);

    el.innerHTML = tasks.map(t => `
        <tr class="${t.done ? 'task-done' : ''}">
            <td><input type="checkbox" class="task-check" style="margin:0" ${t.done ? 'checked' : ''} onclick="toggleTask(${t.id}, '${type}')"></td>
            <td class="task-content" style="${t.done ? 'text-decoration:line-through; color:var(--text-dim);' : ''}">${escapeHtml(t.text)}</td>
            <td><button class="task-star ${t.todayStar ? 'active' : ''}" onclick="toggleStar(${t.id})">‚òÖ</button></td>
            <td><button onclick="deleteTask(${t.id})" class="task-delete">‚úï</button></td>
        </tr>
    `).join('');
}

function renderProjectList(elementId, type) {
    const el = document.getElementById(elementId);
    if (!el) return;
    const tasks = data.tasks.filter(t => t.type === type);
    tasks.sort((a, b) => a.done - b.done);

    el.innerHTML = tasks.map(t => `
        <div class="task-row ${t.done ? 'task-done' : ''}">
            <input type="checkbox" class="task-check" ${t.done ? 'checked' : ''} onclick="toggleTask(${t.id}, 'patri')">
            <span class="task-content">${escapeHtml(t.text)}</span>
            <button class="task-star ${t.todayStar ? 'active' : ''}" onclick="toggleStar(${t.id})">‚òÖ</button>
            <button class="task-delete" onclick="deleteTask(${t.id})">‚úï</button>
        </div>
    `).join('');
}

function renderJournal() {
    const el = document.getElementById('journal-entries');
    const today = new Date().toDateString();
    const todayEntries = data.journal.filter(j => j.date === today);
    if (todayEntries.length === 0) { el.innerHTML = '<div style="color:var(--text-dim); font-size:0.8rem; padding:10px 0; font-style:italic;">Aucune entr√©e aujourd\'hui.</div>'; return; }
    el.innerHTML = todayEntries.map(j => `<div class="journal-entry"><span class="journal-time">[${j.time}]</span><span class="journal-text">${escapeHtml(j.text)}</span></div>`).join('');
}

// ===============================================
// LOGIC
// ===============================================
function addTask(type, text, priority = 'M') {
    data.tasks.unshift({
        id: Date.now() + Math.floor(Math.random() * 1000),
        type, text, done: false, priority,
        todayStar: false, createdAt: new Date().toISOString()
    });
    saveData();
}

function toggleTask(id, pillarKey) {
    const task = data.tasks.find(t => t.id === id);
    if (task) { 
        task.done = !task.done; 
        if (task.done) {
            task.todayStar = false; 
            // AUTO-FILL BUDGET: 1 Task = 0.75h (45 mins)
            data.dailyProgress[pillarKey] = (data.dailyProgress[pillarKey] || 0) + 0.75;
        }
        saveData(); 
    }
}

function deleteTask(id) {
    data.tasks = data.tasks.filter(t => t.id !== id);
    saveData();
}

function toggleStar(id) {
    const task = data.tasks.find(t => t.id === id);
    if (!task) return;
    const currentStars = data.tasks.filter(t => t.todayStar && !t.done).length;
    if (task.todayStar) { task.todayStar = false; }
    else if (currentStars < 3) { task.todayStar = true; }
    else { alert('Max 3 t√¢ches TOP !'); return; }
    saveData();
}

function addNewTask(type) {
    const text = prompt(`Nouvelle t√¢che :`);
    if (text && text.trim()) addTask(type, text.trim());
}

function addProjectTask(type) {
    const input = document.getElementById('input-' + type);
    if (input && input.value.trim()) { addTask(type, input.value.trim()); input.value = ''; }
}

function updateProjectProgress(type) {
    const tasks = data.tasks.filter(t => t.type === type);
    const done = tasks.filter(t => t.done).length;
    const total = tasks.length;
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    const bar = document.getElementById('bar-' + type);
    if (bar) bar.style.width = pct + '%';
}

function updateMetrics() {
    data.metrics.mrr = document.getElementById('input-mrr').value || '0';
    data.metrics.users = document.getElementById('input-users').value || '0';
    saveData();
}

function addJournalEntry(autoText = null) {
    const input = document.getElementById('journal-input');
    const text = autoText || input.value.trim();
    if (!text) return;
    const now = new Date();
    data.journal.unshift({ time: now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }), text, date: now.toDateString() });
    if (!autoText) input.value = '';
    saveData();
}

function toggleJournal() {
    const body = document.getElementById('journal-body');
    const toggle = document.getElementById('journal-toggle');
    body.classList.toggle('expanded');
    toggle.textContent = body.classList.contains('expanded') ? '‚ñ≤ Masquer' : '‚ñº Afficher';
}

function cleanJournalIfNewDay() {
    data.journal = data.journal.filter(j => { const d = new Date(j.date); return (new Date() - d) / 86400000 < 7; });
    saveData();
}

function saveReview() {
    data.review.win = document.getElementById('review-win').value;
    data.review.fail = document.getElementById('review-fail').value;
    data.review.priority = document.getElementById('review-priority').value;
    saveData();
}

function loadReview() {
    document.getElementById('review-win').value = data.review.win || '';
    document.getElementById('review-fail').value = data.review.fail || '';
    document.getElementById('review-priority').value = data.review.priority || '';
}

function createTaskFromPriority() {
    const priority = document.getElementById('review-priority').value.trim();
    if (!priority) { alert('Remplis la priorit√© !'); return; }
    const type = prompt('Type ? (pro / saas / vie)', 'pro');
    if (!['pro', 'saas', 'vie'].includes(type)) { alert('Type invalide'); return; }
    addTask(type, priority, 'H');
    const task = data.tasks.find(t => t.text === priority && !t.done);
    if (task) task.todayStar = true;
    saveData();
    alert('T√¢che cr√©√©e et marqu√©e TOP 3 !');
}

function renderWeekGrid() {
    const weekDays = [
        { name: 'Lundi', theme: 'LAUNCH', color: 'var(--saas-green)', idx: 1 },
        { name: 'Mardi', theme: 'OFFICE', color: 'var(--pro-blue)', idx: 2 },
        { name: 'Mercredi', theme: 'ADMIN', color: 'var(--vie-pink)', idx: 3 },
        { name: 'Jeudi', theme: 'TECH', color: 'var(--saas-green)', idx: 4 },
        { name: 'Vendredi', theme: 'DELIVERY', color: 'var(--pro-blue)', idx: 5 },
        { name: 'W-E', theme: 'VIE', color: 'var(--vie-pink)', idx: 0 }
    ];
    const today = new Date().getDay();
    document.getElementById('week-grid').innerHTML = weekDays.map(d => `
        <div class="week-day ${d.idx === today || (d.idx === 0 && (today === 0 || today === 6)) ? 'today' : ''}">
            <div class="week-day-name" style="color:${d.color}">${d.name}</div>
            <div class="week-day-theme">${d.theme}</div>
        </div>
    `).join('');
}

function renderAll() {
    renderTop3();
    renderPillarGrid();
    renderTable('table-pro-body', 'pro');
    renderTable('table-saas-body', 'saas');
    renderTable('table-vie-body', 'vie');
    renderProjectList('list-annaba', 'annaba');
    renderProjectList('list-copro', 'copro');
    renderProjectList('list-airbnb', 'airbnb');
    renderProjectList('list-maison', 'maison');

    document.getElementById('input-mrr').value = data.metrics.mrr;
    document.getElementById('input-users').value = data.metrics.users;
    if (document.getElementById('date-annaba')) document.getElementById('date-annaba').value = data.settings.annabaDate || '';
    if (document.getElementById('date-copro')) document.getElementById('date-copro').value = data.settings.coproDate || '';

    updateProjectProgress('annaba');
    updateProjectProgress('copro');
    renderJournal();
}

// ===============================================
// IMPORT IA
// ===============================================
function openAiImport() { document.getElementById('ai-import-modal').classList.add('show'); }
function copyAgentPrompt() {
    navigator.clipboard.writeText(AGENT_PROMPT.trim()).then(function() {
        const btn = document.querySelector('.copy-prompt-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚úÖ PROMPT COPI√â !";
        setTimeout(() => { btn.innerHTML = originalText; }, 2000);
    });
}
function processAiImport() {
    const raw = document.getElementById('ai-import-text').value;
    try {
        const cleanRaw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
        const importedTasks = JSON.parse(cleanRaw);
        if(!Array.isArray(importedTasks)) throw new Error("Format incorrect");
        
        let count = 0;
        importedTasks.forEach(t => { if(t.text && t.type) { addTask(t.type, t.text, t.priority || 'M'); count++; } });
        
        document.getElementById('ai-import-text').value = '';
        document.getElementById('ai-import-modal').classList.remove('show');
        alert(count + " t√¢ches import√©es !");
    } catch(e) { alert("Erreur : JSON invalide."); }
}

// ===============================================
// UI UTILS
// ===============================================
function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); }
function checkShutdownTime() { const n = new Date(); if (n.getHours() === 22 && n.getMinutes() === 45) openShutdown(); }
function openShutdown() { document.getElementById('shutdown-modal').classList.add('show'); }
function closeShutdown() { document.getElementById('shutdown-modal').classList.remove('show'); }
function switchTab(viewId, btn) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + viewId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if (btn) btn.classList.add('active');
}
function toggleCrisisMode() { data.settings.crisisMode = !data.settings.crisisMode; saveData(); updateCrisisUI(); }
function updateCrisisUI() {
    const header = document.getElementById('main-header');
    const crisisTag = document.getElementById('crisis-tag');
    const btnCrisis = document.getElementById('btn-crisis');
    if (data.settings.crisisMode) { header.classList.add('crisis-active'); crisisTag.classList.remove('hidden'); btnCrisis.classList.add('active'); } 
    else { header.classList.remove('crisis-active'); crisisTag.classList.add('hidden'); btnCrisis.classList.remove('active'); }
}
function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function exportData() { const a = document.createElement('a'); a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, null, 2)); a.download = 'huzine_os_' + new Date().toISOString().slice(0, 10) + '.json'; a.click(); }
function importData(input) { const f = input.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { try { data = JSON.parse(e.target.result); saveData(); alert('Restaur√© !'); location.reload(); } catch { alert('Fichier invalide'); } }; r.readAsText(f); }

// ===============================================
// FOCUS & TIMER
// ===============================================
let focusModeActive = false, focusTimerInterval = null, focusSeconds = 0, currentFocusTaskId = null;
function startFocusOnTask(taskId) {
    const task = data.tasks.find(t => t.id === taskId);
    if (!task || task.done) return;
    currentFocusTaskId = taskId;
    document.getElementById('focus-task-text').textContent = task.text;
    document.getElementById('focus-type-label').textContent = task.type.toUpperCase();
    focusSeconds = 0;
    document.getElementById('focus-timer-display').textContent = '00:00';
    document.getElementById('focus-toggle-btn').textContent = '‚ñ∂ Timer';
    document.getElementById('focus-overlay').classList.add('show');
    focusModeActive = true;
}
function toggleFocusMode() {
    if (focusModeActive) { exitFocusMode(); return; }
    let task = data.tasks.find(t => t.todayStar && !t.done);
    if (!task) task = data.tasks.find(t => !t.done && ['pro', 'saas', 'vie'].includes(t.type));
    if (task) startFocusOnTask(task.id); else alert('Aucune t√¢che active !');
}
function exitFocusMode() { document.getElementById('focus-overlay').classList.remove('show'); focusModeActive = false; currentFocusTaskId = null; clearInterval(focusTimerInterval); focusTimerInterval = null; }
function completeFocusTask() { if (currentFocusTaskId) { const task = data.tasks.find(t => t.id === currentFocusTaskId); if (task) { task.done = true; task.todayStar = false; 
    const pillarKey = getPillarKey(task.type);
    data.dailyProgress[pillarKey] = (data.dailyProgress[pillarKey] || 0) + 0.75; // Add time
    addJournalEntry(`‚úì ${task.text}`); saveData(); } nextFocusTask(); } }
function nextFocusTask() { clearInterval(focusTimerInterval); focusTimerInterval = null; focusSeconds = 0; let next = data.tasks.find(t => t.todayStar && !t.done && t.id !== currentFocusTaskId); if (!next) next = data.tasks.find(t => !t.done && t.id !== currentFocusTaskId); if (next) startFocusOnTask(next.id); else { document.getElementById('focus-task-text').textContent = 'üéâ Tout est termin√© !'; currentFocusTaskId = null; } }
function toggleFocusTimer() { const btn = document.getElementById('focus-toggle-btn'); if (focusTimerInterval) { clearInterval(focusTimerInterval); focusTimerInterval = null; btn.textContent = '‚ñ∂ Reprendre'; } else { focusTimerInterval = setInterval(() => { focusSeconds++; const m = String(Math.floor(focusSeconds/60)).padStart(2,'0'), s = String(focusSeconds%60).padStart(2,'0'); document.getElementById('focus-timer-display').textContent = m+':'+s; }, 1000); btn.textContent = '‚è∏ Pause'; } }

init();
</script>
</body>
</html>
